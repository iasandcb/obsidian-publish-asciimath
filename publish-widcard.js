var m=(x=>(x.NumberLiteral="NumberLiteral",x.StringLiteral="StringLiteral",x.Text="Text",x.Const="Const",x.OperatorOA="OperatorA",x.OperatorOAB="OperatorOAB",x.OperatorAOB="OperatorAOB",x.OperatorMinus="OperatorMinus",x.OperatorAO="OperatorAO",x.OperatorO2="OperatorOptionalTwoParams",x.OperatorSup="OperatorSup",x.OperatorPartial="OperatorPartial",x.LParen="LParen",x.RParen="RParen",x.Paren="Paren",x.Align="Align",x.Split="Split",x.None="None",x))(m||{}),f=new Map([["alpha",{type:"Const",tex:"\\alpha"}],["beta",{type:"Const",tex:"\\beta"}],["gamma",{type:"Const",tex:"\\gamma"}],["Gamma",{type:"Const",tex:"\\Gamma"}],["delta",{type:"Const",tex:"\\delta"}],["Delta",{type:"Const",tex:"\\Delta"}],["epsi",{type:"Const",tex:"\\varepsilon"}],["epsilon",{type:"Const",tex:"\\epsilon"}],["varepsilon",{type:"Const",tex:"\\varepsilon"}],["zeta",{type:"Const",tex:"\\zeta"}],["eta",{type:"Const",tex:"\\eta"}],["theta",{type:"Const",tex:"\\theta"}],["Theta",{type:"Const",tex:"\\Theta"}],["vartheta",{type:"Const",tex:"\\vartheta"}],["iota",{type:"Const",tex:"\\iota"}],["kappa",{type:"Const",tex:"\\kappa"}],["lambda",{type:"Const",tex:"\\lambda"}],["Lambda",{type:"Const",tex:"\\Lambda"}],["mu",{type:"Const",tex:"\\mu"}],["nu",{type:"Const",tex:"\\nu"}],["xi",{type:"Const",tex:"\\xi"}],["Xi",{type:"Const",tex:"\\Xi"}],["pi",{type:"Const",tex:"\\pi"}],["Pi",{type:"Const",tex:"\\Pi"}],["rho",{type:"Const",tex:"\\rho"}],["sigma",{type:"Const",tex:"\\sigma"}],["Sigma",{type:"Const",tex:"\\Sigma"}],["tau",{type:"Const",tex:"\\tau"}],["upsilon",{type:"Const",tex:"\\upsilon"}],["phi",{type:"Const",tex:"\\phi"}],["varphi",{type:"Const",tex:"\\varphi"}],["varPhi",{type:"Const",tex:"\\varPhi"}],["phv",{type:"Const",tex:"\\varphi"}],["Phv",{type:"Const",tex:"\\varPhi"}],["Phi",{type:"Const",tex:"\\Phi"}],["chi",{type:"Const",tex:"\\chi"}],["psi",{type:"Const",tex:"\\psi"}],["Psi",{type:"Const",tex:"\\Psi"}],["omega",{type:"Const",tex:"\\omega"}],["Omega",{type:"Const",tex:"\\Omega"}],["***",{type:"Const",tex:"\\star"}],["star",{type:"Const",tex:"\\star"}],["**",{type:"Const",tex:"\\ast"}],["ast",{type:"Const",tex:"\\ast"}],["*",{type:"Const",tex:"\\cdot"}],["cdot",{type:"Const",tex:"\\cdot"}],["//",{type:"Const",tex:"{/}"}],["\\\\",{type:"Const",tex:"\\backslash"}],["setminus",{type:"Const",tex:"\\setminus"}],["xx",{type:"Const",tex:"\\times"}],["|><",{type:"Const",tex:"\\ltimes"}],["><|",{type:"Const",tex:"\\rtimes"}],["|><|",{type:"Const",tex:"\\bowtie"}],["-:",{type:"Const",tex:"\\div"}],["@",{type:"Const",tex:"\\circ"}],["o+",{type:"Const",tex:"\\oplus"}],["ox",{type:"Const",tex:"\\otimes"}],["o.",{type:"Const",tex:"\\odot"}],["sum",{type:"Const",tex:"\\sum"}],["prod",{type:"Const",tex:"\\prod"}],["^^",{type:"Const",tex:"\\wedge"}],["^^^",{type:"Const",tex:"\\bigwedge"}],["vv",{type:"Const",tex:"\\vee"}],["vvv",{type:"Const",tex:"\\bigvee"}],["nn",{type:"Const",tex:"\\cap"}],["nnn",{type:"Const",tex:"\\bigcap"}],["uu",{type:"Const",tex:"\\cup"}],["uuu",{type:"Const",tex:"\\bigcup"}],["!=",{type:"Const",tex:"\\ne"}],["lt",{type:"Const",tex:"<"}],["<<",{type:"Const",tex:"\\ll"}],[">>",{type:"Const",tex:"\\gg"}],["<=",{type:"Const",tex:"\\leqslant"}],["le",{type:"Const",tex:"\\le"}],["gt",{type:"Const",tex:">"}],[">=",{type:"Const",tex:"\\geqslant"}],["ge",{type:"Const",tex:"\\ge"}],["-<",{type:"Const",tex:"\\prec"}],[">-",{type:"Const",tex:"\\succ"}],["-<=",{type:"Const",tex:"\\preceq"}],[">-=",{type:"Const",tex:"\\succeq"}],["in",{type:"Const",tex:"\\in"}],["!in",{type:"Const",tex:"\\notin"}],["sub",{type:"Const",tex:"\\subset"}],["sup",{type:"Const",tex:"\\supset"}],["sube",{type:"Const",tex:"\\subseteq"}],["supe",{type:"Const",tex:"\\supseteq"}],["-=",{type:"Const",tex:"\\equiv"}],["~=",{type:"Const",tex:"\\cong"}],["~",{type:"Const",tex:"\\sim"}],["~~",{type:"Const",tex:"\\approx"}],["\\#",{type:"Const",tex:"\\#"}],["\\&",{type:"Const",tex:"\\&"}],["\\@",{type:"Const",tex:"@"}],["\\%",{type:"Const",tex:"\\%"}],["%",{type:"Const",tex:"\\%"}],["\\_",{type:"Const",tex:"\\_"}],["\\^",{type:"Const",tex:"\\^"}],["\\$",{type:"Const",tex:"\\$"}],["\\ ",{type:"Const",tex:"\\ "}],["\\,",{type:"Const",tex:"\\,"}],["\\;",{type:"Const",tex:"\\;"}],["\\:",{type:"Const",tex:"\\:"}],["\\!",{type:"Const",tex:"\\!"}],["enspace",{type:"Const",tex:"\\enspace"}],["hspace",{type:"OperatorA",tex:"\\hspace{$1}",eatNext:!0}],["prop",{type:"Const",tex:"\\propto"}],["comp",{type:"Const",tex:"\\complement"}],["complement",{type:"Const",tex:"\\complement"}],[":=",{type:"Const",tex:"\\coloneqq"}],["=:",{type:"Const",tex:"\\eqqcolon"}],["if",{type:"Text",tex:"if\\quad"}],["otherwise",{type:"Text",tex:"otherwise\\quad"}],["and",{type:"Text",tex:" and "}],["or",{type:"Text",tex:" or "}],["not",{type:"Const",tex:"\\neg"}],["=>",{type:"Const",tex:"\\implies"}],["=/=>",{type:"Const",tex:"\\centernot\\implies"}],["~>",{type:"Const",tex:"\\rightsquigarrow"}],["-/->",{type:"Const",tex:"\\nrightarrow"}],["<-/-",{type:"Const",tex:"\\nleftarrow"}],["<-/->",{type:"Const",tex:"\\nleftrightarrow"}],["<==",{type:"Const",tex:"\\;\\Longleftarrow\\;"}],["<=>",{type:"Const",tex:"\\iff"}],["<=/=>",{type:"Const",tex:"\\centernot\\iff"}],["iff",{type:"Const",tex:"\\iff"}],["!iff",{type:"Const",tex:"\\centernot\\iff"}],["AA",{type:"Const",tex:"\\forall"}],["EE",{type:"Const",tex:"\\exists"}],["_|_",{type:"Const",tex:"\\bot"}],["TT",{type:"Const",tex:"\\top"}],["|--",{type:"Const",tex:"\\vdash"}],["|==",{type:"Const",tex:"\\models"}],["int",{type:"Const",tex:"\\int"}],["oint",{type:"Const",tex:"\\oint"}],["del",{type:"Const",tex:"\\partial"}],["grad",{type:"Const",tex:"\\nabla"}],["+-",{type:"Const",tex:"\\pm"}],["-+",{type:"Const",tex:"\\mp"}],["O/",{type:"Const",tex:"\\varnothing"}],["oo",{type:"Const",tex:"\\infty"}],["aleph",{type:"Const",tex:"\\aleph"}],["...",{type:"Const",tex:"\\ldots"}],[":.",{type:"Const",tex:"\\therefore"}],[":'",{type:"Const",tex:"\\because"}],["/_",{type:"Const",tex:"\\angle"}],["/_\\",{type:"Const",tex:"\\triangle"}],["quad",{type:"Const",tex:"\\quad"}],["qquad",{type:"Const",tex:"\\qquad"}],["cdots",{type:"Const",tex:"\\cdots"}],["vdots",{type:"Const",tex:"\\vdots"}],["ddots",{type:"Const",tex:"\\ddots"}],["diamond",{type:"Const",tex:"\\diamond"}],["Lap",{type:"Const",tex:"\\mathscr{L}"}],["square",{type:"Const",tex:"\\square"}],["|__",{type:"LParen",tex:"\\lfloor"}],["__|",{type:"RParen",tex:"\\rfloor"}],["|~",{type:"LParen",tex:"\\lceil"}],["~|",{type:"RParen",tex:"\\rceil"}],["CC",{type:"Const",tex:"\\mathbb{C}"}],["NN",{type:"Const",tex:"\\mathbb{N}"}],["QQ",{type:"Const",tex:"\\mathbb{Q}"}],["RR",{type:"Const",tex:"\\mathbb{R}"}],["ZZ",{type:"Const",tex:"\\mathbb{Z}"}],["'",{type:"Const",tex:"^{\\prime}"}],["''",{type:"Const",tex:"^{\\prime\\prime}"}],["'''",{type:"Const",tex:"^{\\prime\\prime\\prime}"}],["lim",{type:"Const",tex:"\\lim"}],["sin",{type:"Const",tex:"\\sin"}],["cos",{type:"Const",tex:"\\cos"}],["tan",{type:"Const",tex:"\\tan"}],["sinh",{type:"Const",tex:"\\sinh"}],["cosh",{type:"Const",tex:"\\cosh"}],["tanh",{type:"Const",tex:"\\tanh"}],["cot",{type:"Const",tex:"\\cot"}],["sec",{type:"Const",tex:"\\sec"}],["csc",{type:"Const",tex:"\\csc"}],["arcsin",{type:"Const",tex:"\\arcsin"}],["arccos",{type:"Const",tex:"\\arccos"}],["arctan",{type:"Const",tex:"\\arctan"}],["coth",{type:"Const",tex:"\\coth"}],["sech",{type:"Const",tex:"\\operatorname{sech}"}],["csch",{type:"Const",tex:"\\operatorname{csch}"}],["exp",{type:"Const",tex:"\\exp"}],["log",{type:"Const",tex:"\\log"}],["ln",{type:"Const",tex:"\\ln"}],["det",{type:"Const",tex:"\\det"}],["dim",{type:"Const",tex:"\\dim"}],["gcd",{type:"Const",tex:"\\gcd"}],["lcm",{type:"Const",tex:"\\operatorname{lcm}"}],["min",{type:"Const",tex:"\\min"}],["max",{type:"Const",tex:"\\max"}],["Sup",{type:"Const",tex:"\\sup"}],["inf",{type:"Const",tex:"\\inf"}],["mod",{type:"Const",tex:"\\operatorname{mod}"}],["sgn",{type:"Const",tex:"\\operatorname{sgn}"}],["arg",{type:"Const",tex:"\\operatorname{arg}"}],["Arg",{type:"Const",tex:"\\operatorname{Arg}"}],["abs",{type:"OperatorA",tex:"\\left| $1 \\right|"}],["norm",{type:"OperatorA",tex:"\\left\\| $1 \\right\\|"}],["floor",{type:"OperatorA",tex:"\\left\\lfloor $1 \\right\\rfloor"}],["ceil",{type:"OperatorA",tex:"\\left\\lceil $1 \\right\\rceil"}],["uarr",{type:"Const",tex:"\\uparrow"}],["uparrow",{type:"Const",tex:"\\uparrow"}],["darr",{type:"Const",tex:"\\downarrow"}],["downarrow",{type:"Const",tex:"\\downarrow"}],["rarr",{type:"Const",tex:"\\rightarrow"}],["rightarrow",{type:"Const",tex:"\\rightarrow"}],["to",{type:"Const",tex:"\\to"}],["->",{type:"Const",tex:"\\to"}],["<-",{type:"Const",tex:"\\gets"}],[">->",{type:"Const",tex:"\\rightarrowtail"}],["->>",{type:"Const",tex:"\\twoheadrightarrow"}],[">->>",{type:"Const",tex:"\u2916"}],["|->",{type:"Const",tex:"\\mapsto"}],["larr",{type:"Const",tex:"\\leftarrow"}],["leftarrow",{type:"Const",tex:"\\leftarrow"}],["harr",{type:"Const",tex:"\\leftrightarrow"}],["rArr",{type:"Const",tex:"\\Rightarrow"}],["lArr",{type:"Const",tex:"\\Leftarrow"}],["hArr",{type:"Const",tex:"\\Leftrightarrow"}],["curvArrLt",{type:"Const",tex:"\\curvearrowleft"}],["curvArrRt",{type:"Const",tex:"\\curvearrowright"}],["circArrLt",{type:"Const",tex:"\\circlearrowleft"}],["circArrRt",{type:"Const",tex:"\\circlearrowright"}],["sqrt",{type:"OperatorA",tex:"\\sqrt{ $1 }"}],["root",{type:"OperatorOAB",tex:"\\sqrt[ $1 ]{ $2 }"}],["frac",{type:"OperatorOAB",tex:"\\frac{ $1 }{ $2 }"}],["/",{type:"OperatorAOB",tex:"\\frac{ $1 }{ $2 }"}],["choose",{type:"OperatorAOB",tex:"{ $1 \\choose $2 }"}],["_",{type:"OperatorSup",tex:"_{ $1 }"}],["^",{type:"OperatorSup",tex:"^{ $1 }"}],["stackrel",{type:"OperatorOAB",tex:"\\stackrel{ $1 }{ $2 }"}],["overset",{type:"OperatorOAB",tex:"\\overset{ $1 }{ $2 }"}],["underset",{type:"OperatorOAB",tex:"\\underset{ $1 }{ $2 }"}],["hat",{type:"OperatorA",tex:"\\hat{ $1 }"}],["\\`",{type:"OperatorA",tex:"\\`{ $1 }"}],["widehat",{type:"OperatorA",tex:"\\widehat{ $1 }"}],["Hat",{type:"OperatorA",tex:"\\widehat{ $1 }"}],["widetilde",{type:"OperatorA",tex:"\\widetilde{ $1 }"}],["ol",{type:"OperatorA",tex:"\\overline{ $1 }"}],["overline",{type:"OperatorA",tex:"\\overline{ $1 }"}],["arc",{type:"OperatorA",tex:"\\stackrel{\\frown}{ $1 }"}],["bar",{type:"OperatorA",tex:"\\bar{ $1 }"}],["vec",{type:"OperatorA",tex:"\\vec{ $1 }"}],["Vec",{type:"OperatorA",tex:"\\overrightarrow{ $1 }"}],["Aec",{type:"OperatorA",tex:"\\overleftarrow{ $1 }"}],["tilde",{type:"OperatorA",tex:"\\tilde{ $1 }"}],["Tilde",{type:"OperatorA",tex:"\\widetilde{ $1 }"}],["dot",{type:"OperatorA",tex:"\\dot{ $1 }"}],["ddot",{type:"OperatorA",tex:"\\ddot{ $1 }"}],["ul",{type:"OperatorA",tex:"\\underline{ $1 }"}],["underline",{type:"OperatorA",tex:"\\underline{ $1 }"}],["underbrace",{type:"OperatorA",tex:"\\underbrace{ $1 }"}],["ubrace",{type:"OperatorA",tex:"\\underbrace{ $1 }"}],["overbrace",{type:"OperatorA",tex:"\\overbrace{ $1 }"}],["obrace",{type:"OperatorA",tex:"\\overbrace{ $1 }"}],["color",{type:"OperatorOAB",tex:"{ \\color{$1} $2 }",eatNext:!0}],["phantom",{type:"OperatorA",tex:"\\phantom{$1}"}],["text",{type:"OperatorA",tex:"\\text{$1}",eatNext:!0}],["tex",{type:"OperatorA",tex:"$1",eatNext:!0}],["mbox",{type:"OperatorA",tex:"\\mbox{$1}"}],["op",{type:"OperatorA",tex:"\\operatorname{ $1 }",eatNext:!0}],["cancel",{type:"OperatorA",tex:"\\cancel{ $1 }"}],["bb",{type:"OperatorA",tex:"\\mathbf{ $1 }"}],["mathbf",{type:"OperatorA",tex:"\\mathbf{ $1 }"}],["sf",{type:"OperatorA",tex:"\\mathsf{ $1 }"}],["mathsf",{type:"OperatorA",tex:"\\mathsf{ $1 }"}],["bbb",{type:"OperatorA",tex:"\\mathbb{ $1 }"}],["mathbb",{type:"OperatorA",tex:"\\mathbb{ $1 }"}],["cc",{type:"OperatorA",tex:"\\mathcal{ $1 }"}],["mathcal",{type:"OperatorA",tex:"\\mathcal{ $1 }"}],["tt",{type:"OperatorA",tex:"\\mathtt{ $1 }"}],["mathtt",{type:"OperatorA",tex:"\\mathtt{ $1 }"}],["fr",{type:"OperatorA",tex:"\\mathfrak{ $1 }"}],["bm",{type:"OperatorA",tex:"\\boldsymbol{ $1 }"}],["rm",{type:"OperatorA",tex:"\\mathrm{ $1 }"}],["scr",{type:"OperatorA",tex:"\\mathscr{ $1 }"}],["limits",{type:"OperatorA",tex:"\\mathop{ $1 }\\limits"}],["iint",{type:"Const",tex:"\\iint"}],["iiint",{type:"Const",tex:"\\iiint"}],["oiint",{type:"Const",tex:"\u222F"}],["oiiint",{type:"Const",tex:"\u2230"}],["laplace",{type:"Const",tex:"\\Delta"}],["==",{type:"OperatorOptionalTwoParams",tex:"\\xlongequal[ $2 ]{ $1 }"}],["-->",{type:"OperatorOptionalTwoParams",tex:"\\xrightarrow[ $2 ]{ $1 }"}],["||",{type:"Paren",tex:"\\Vert"}],["!||",{type:"Const",tex:"\u2226"}],["S=",{type:"Const",tex:"\u224C"}],["S~",{type:"Const",tex:"\u223D"}],["!-=",{type:"Const",tex:"\\not\\equiv"}],["!|",{type:"Const",tex:"\u2224"}],["!",{type:"OperatorAO",tex:"{$1 !}"}],["!!",{type:"OperatorAO",tex:"{$1 !!}"}],["!sube",{type:"Const",tex:"\\not\\subseteq"}],["!supe",{type:"Const",tex:"\\not\\supseteq"}],["subne",{type:"Const",tex:"\\subsetneqq"}],["supne",{type:"Const",tex:"\\supsetneqq"}],["lhd",{type:"Const",tex:"\\lhd"}],["rhd",{type:"Const",tex:"\\rhd"}],["normal",{type:"Const",tex:"\\unlhd"}],["rnormal",{type:"Const",tex:"\\unrhd"}],["hline",{type:"Const",tex:"\\hline"}],["--",{type:"Const",tex:"\\hline"}],["(",{type:"LParen",tex:"("}],[")",{type:"RParen",tex:")"}],["[",{type:"LParen",tex:"["}],["]",{type:"RParen",tex:"]"}],["{",{type:"LParen",tex:"\\lbrace"}],["}",{type:"RParen",tex:"\\rbrace"}],["(:",{type:"LParen",tex:"\\langle"}],[":)",{type:"RParen",tex:"\\rangle"}],["{:",{type:"LParen",tex:"."}],[":}",{type:"RParen",tex:"."}],["|",{type:"Paren",tex:"|"}],["mid",{type:"Const",tex:"\\mid"}],["&",{type:"Align",tex:"&"}],["&&",{type:"Align",tex:"&&"}],[",",{type:"Split",tex:","}],[";",{type:"Split",tex:";"}],["-",{type:"OperatorMinus",tex:"{-$1 }"}],["+",{type:"OperatorMinus",tex:"{+$1 }"}],["part",{type:"OperatorPartial",tex:"\\partial"}],["pp",{type:"OperatorPartial",tex:"\\partial"}],["dd",{type:"OperatorPartial",tex:"\\mathrm{d}"}],["tiny",{type:"OperatorA",tex:"{\\tiny $1 }"}],["small",{type:"OperatorA",tex:"{\\small $1 }"}],["large",{type:"OperatorA",tex:"{\\large $1 }"}],["huge",{type:"OperatorA",tex:"{\\huge $1 }"}],["o1",{type:"Const",tex:"\u2460"}],["o2",{type:"Const",tex:"\u2461"}],["o3",{type:"Const",tex:"\u2462"}],["o4",{type:"Const",tex:"\u2463"}],["o5",{type:"Const",tex:"\u2464"}],["o6",{type:"Const",tex:"\u2465"}],["ce",{type:"OperatorA",tex:"\\ce{$1}",eatNext:!0}],["Ksp",{type:"Const",tex:"K_{\\text{sp}}"}],["Ka1",{type:"Const",tex:"K_{\\text{a}_1}"}],["Ka2",{type:"Const",tex:"K_{\\text{a}_2}"}],["Ka3",{type:"Const",tex:"K_{\\text{a}_3}"}],["Ka",{type:"Const",tex:"K_{\\text{a}}"}],["Kb",{type:"Const",tex:"K_{\\text{b}}"}],["Kh1",{type:"Const",tex:"K_{\\text{h}_1}"}],["Kh2",{type:"Const",tex:"K_{\\text{h}_2}"}],["Kh3",{type:"Const",tex:"K_{\\text{h}_3}"}],["Kh",{type:"Const",tex:"K_{\\text{h}}"}],["Kw",{type:"Const",tex:"K_{\\text{w}}"}],["pH",{type:"Const",tex:"\\mathrm{pH}"}],["pOH",{type:"Const",tex:"\\mathrm{pOH}"}],["cyc",{type:"Const",tex:"\\mathrm{cyc}"}]]);function z(){return{type:"Root",body:[]}}function l(o){if(typeof o>"u")return{type:"Const",value:"",tex:""};if(typeof o=="string")return{type:"Const",value:o,tex:o};let e;return o.type==="Text"?e=o.tex.replace(/^(\\quad)?(.+?)(\\quad)?$/,(t,n,p,s)=>`${n||""}\\text{${p}}${s||""}`):e=o.tex,{type:"Const",value:o.value,tex:e}}function k(o){let e=[];return o&&(Array.isArray(o)?e=o:e.push(o)),{type:"Flat",body:e}}function $(){return{type:"Matrix",params:[],lparen:".",rparen:".",alignment:"c",dividerIndices:[]}}function c(){return{type:"ParamOne",tex:"",params:k()}}function g(){return{type:"ParamTwo",tex:"",params:[k(),k()]}}function w(o,e){return{type:"Const",value:o.value,tex:`\\${e?"left":"right"}${o.tex}`}}function d(o){return o.type!=="Flat"?o:o.body.length===1?o.body[0].type!=="Flat"?o.body[0]:d(o.body[0]):o}function L(o,e){let{closingIndex:t,semiIndex:n}=E(e,o);return t===-1?B(o,e):n===-1||n>t?q(o,e,t):M(o,e,t)}function v(o,e){if(e+1>=o.length)return;let t=o[e],n=o[e+1];t.type==="Const"&&t.tex==="\\hline"&&n.type==="Paren"&&([o[e],o[e+1]]=[n,t])}function M(o,e,t){let n=o[e],p=$(),s=new Set;p.lparen=`\\left${n.tex}`,e++;let a=[],r=null;v(o,e),n=o[e];let i=0,y=e;for(;e<t;){if(n=o[e],n.type==="Split"&&n.value===","){r?(a.push(d(r)),r=null):a.push(l()),++e;continue}if(n.type==="Split"&&n.value===";"||n.type==="Align"&&n.tex==="\\\\"){r&&(a.push(d(r)),r=null),p.params.push(a),a=[],e++,v(o,e);continue}if(n.type==="Paren"){r&&(a.push(d(r)),r=null),s.add(a.length),e++;continue}for(r=k();e<t&&n.type!=="Split"&&n.type!=="Paren"&&n.type!=="Align";){let T=u(o,e);e=T.current,r.body.push(T.node),n=o[e]}if(i++,i>t-y+10)throw new Error(`Caught potential infinit loop in matrix parser! Cannot consume token \`${n.value}\` in ${i} loops (maybe greater than the token length)!`)}return r&&(r=d(r),a.push(r),r=null),a.length>0&&(p.params.push(a),a=[]),p.dividerIndices=Array.from(s).sort((T,V)=>T-V),n=o[e],e<o.length?(e++,p.rparen=`\\right${n.tex}`,n.value===":}"&&p.lparen.endsWith("lbrace")&&(p.alignment="l")):p.rparen="\\right.",{node:p,current:e}}var O=class extends Error{};function q(o,e,t){let n=o[e],p=k();if(p.body.push(w(n,!0)),e=N(e+1,t,o,p),e>=o.length)throw new O(`Read index out of range at line: ${n.pos.line}, ch: ${n.pos.ch}.`);return n=o[e],e++,p.body.push(w(n,!1)),p.body[0].value==="{:"&&p.body[p.body.length-1].value===":}"&&(p.body[0].tex="{",p.body[p.body.length-1].tex="}"),{node:p,current:e}}function B(o,e){let t=o[e],n=k();return n.body.push({type:"Const",value:t.value,tex:`\\left${t.tex}`}),e=N(e+1,o.length,o,n),n.body.push({type:"Const",value:".",tex:"\\right."}),{node:n,current:e}}function E(o,e){let t=-1,n=-1,p=[];for(let s=o+1;s<e.length;s++){if(e[s].type==="LParen"){p.push("");continue}if(p.length===0){if(e[s].value===";"?t===-1&&(t=s):e[s].type==="RParen"&&n===-1&&(n=s),t!==-1&&n!==-1)break}else e[s].type==="RParen"&&p.pop()}return{closingIndex:n,semiIndex:t}}function K(o,e,t,n){let p=-1,s=-1,a=[];for(let r=e;r<t;r++){if(o[r].type==="LParen"){a.push("");continue}if(a.length>0&&o[r].type==="RParen"){a.pop();continue}if(!(a.length>0)&&(o[r].type==="RParen"||(o[r].value===";"?p===-1&&(p=r):o[r].value===n&&s===-1&&(s=r),p!==-1&&s!==-1)))break}return{semiIndex:p,barIndex:s}}function I(o,e){let t=o[e],{semiIndex:n,barIndex:p}=K(o,e+1,o.length,t.value);if(p===-1)return W(e,t);if(n===-1||n>p){let i=k();return e++,i.body.push(l(`\\left${t.tex}`)),e=N(e,p,o,i),i.body.push(l(`\\right${t.tex}`)),e=p+1,{current:e,node:i}}let s=$();s.lparen=`\\left${t.tex}`,s.rparen=`\\right${t.tex}`,t=o[++e];let a=[],r=null;for(;e<p;){if(t.type==="Split"){switch(t.value){case",":{r?(r.type==="Flat"&&(r=d(r)),a.push(r),r=null):a.push(l());break}case";":{r&&(r.type==="Flat"&&(r=d(r)),a.push(r),r=null),s.params.push(a),a=[];break}}t=o[++e];continue}for(r=k(),t=o[e];e<p&&t.type!=="Split";){let i=u(o,e);e=i.current,r.body.push(i.node),t=o[e]}}return r&&(r=d(r),a.push(r),r=null),a.length>0&&(s.params.push(a),a=[]),e=p+1,{node:s,current:e}}function N(o,e,t,n){for(;o<e;){let p=u(t,o);o=p.current,n.body.push(p.node)}return o}function W(o,e){return{current:o+1,node:{type:"Const",value:e.value,tex:e.tex==="|"?"|":e.tex}}}function h(o){let e=o.body[0],t=o.body[o.body.length-1];return e.type==="Const"&&t.type==="Const"&&e.value==="("&&t.value===")"&&(o.body.pop(),o.body.shift()),o}function D(o,e,t){let n=o[e],p=l(),s="",a="",r="";if(n.value==="^"||n.value==="_"){s=n.value==="^"?"_":"^",a=n.value,e++;let T=u(o,e,!1);T.node.type==="Flat"&&(T.node=h(T.node)),p=T.node,e=T.current}let i=l();if(e<o.length&&(n=o[e],n.value===s)){r=n.value,e++;let T=u(o,e,!1);T.node.type==="Flat"&&(T.node=h(T.node)),i=T.node,e=T.current}let y=g();return y.tex=t.tex,y.params[0]=a==="^"?p:r==="^"?i:l(),y.params[1]=a==="_"?p:r==="_"?i:l(),{node:y,current:e}}function j(o,e,t,n){let p;o.type==="Flat"?p=o:(p=k(),p.body.push(o));let s=c();s.tex=e.tex;let a=u(t,n,!1);if(n=a.current,a.node.type==="Flat")a.node=h(a.node);else if(a.node.type==="Matrix"){let r=a.node;r.lparen.endsWith("(")&&r.rparen.endsWith(")")&&(r.lparen="",r.rparen="")}return s.params=a.node,s.params.type==="Flat"&&(s.params=d(s.params)),p.body.push(s),o=d(p),{node:o,current:n}}function H(o,e){let t=c();return t.params=o,t.tex=e.tex,o=t,o}function G(o,e,t,n){let p=g();o.type==="Flat"&&(o=d(h(o))),p.tex=e.tex,p.params[0]=o;let s=u(t,n);return n=s.current,s.node.type==="Flat"&&(s.node=d(h(s.node))),p.params[1]=s.node,o=p,{node:o,current:n}}function P(o,e,t){let n=c(),p=o[e];n.tex=p.tex,e++;let s=u(o,e,t);return e=s.current,s.node.type==="Flat"&&(s.node=d(h(s.node))),n.params=s.node,{node:n,current:e}}function Q(o,e){let t=o[e];if(e>0){let a=o[e-1];if(a.type!=="OperatorSup"&&a.type!=="OperatorA"&&a.type!=="OperatorOAB"&&a.type!=="OperatorAOB")return{node:l(t.value),current:e+1}}else return{node:l(t.value),current:e+1};if(e++,e>=o.length)return{node:l(t.value),current:e};if(o[e].type==="RParen")return{node:l(t.value),current:e};let p=u(o,e,!0);e=p.current;let s=c();return s.tex=t.tex,s.params=p.node,{node:s,current:e}}function U(o,e,t){let n=k();return n.body.push(l(o)),e&&n.body.push(e),n.body.push(t),n}function Z(o,e){return k(o.body.flatMap(t=>[l(e),t]))}function X(o,e){let t=g(),n=o[e];t.tex="\\frac{ $1 }{ $2 }";let p=n.tex,s=null;if(e++,e>=o.length)return{node:t,current:e};if(n=o[e],n.type==="OperatorSup"){let i=P(o,e,!1);e=i.current,s=i.node}let a=u(o,e,!0);if(e=a.current,a.node.type==="Flat"&&(a.node=h(a.node)),t.params[0]=U(p,s,a.node),e>=o.length)return{node:t,current:e};let r=u(o,e);return e=r.current,r.node.type==="Flat"?(r.node=h(r.node),r.node=Z(r.node,p)):(r.node=k(r.node),r.node.body.unshift(l(p)),s&&r.node.body.push(s)),t.params[1]=r.node,{node:t,current:e}}function u(o,e,t=!0){if(e>=o.length)return{node:l(),current:e};let n=o[e],p;switch(n.type){case"Const":case"Text":case"NumberLiteral":case"StringLiteral":{e++,p=l(n);break}case"LParen":{({node:p,current:e}=L(o,e));break}case"Paren":{({node:p,current:e}=I(o,e));break}case"OperatorSup":case"OperatorA":{({node:p,current:e}=P(o,e,!1));break}case"OperatorMinus":{({node:p,current:e}=Q(o,e));break}case"OperatorOAB":{p=g(),p.tex=n.tex,e++;let s=u(o,e);e=s.current,s.node.type==="Flat"&&(s.node=d(h(s.node))),p.params[0]=s.node;let a=u(o,e);e=a.current,a.node.type==="Flat"&&(a.node=d(h(a.node))),p.params[1]=a.node;break}case"OperatorOptionalTwoParams":{if(e++,e>=o.length){p=l(`${n.tex.replace(/[\{\[] \$\d+ [\}\]]/g,"")}{}`);break}({node:p,current:e}=D(o,e,n));break}case"OperatorPartial":{({node:p,current:e}=X(o,e));break}case"Split":case"Align":{e++,p=l(n);break}case"RParen":{e++,p=l(n);break}default:throw new Error(`Unmatched token \`${n.value}\` at line: ${n.pos.line}, ch: ${n.pos.ch}.`)}if(e<o.length&&t){let s=!0;for(;s&&e<o.length;){let a=o[e];switch(a.type){case"OperatorAOB":{({node:p,current:e}=G(p,a,o,e+1));break}case"OperatorAO":{p=H(p,a),e++;break}case"OperatorSup":{({node:p,current:e}=j(p,a,o,e+1));break}default:s=!1}}}return{node:p,current:e}}function R(o){let e=z(),t=0;for(;t<o.length;){let n=u(o,t);t=n.current,e.body.push(n.node)}return e}function Y(o){let e=o.dividerIndices,t="\\begin{array}",n=o.alignment;if(e.length){let p=e[e.length-1];for(let a=e.length-1;a>=1;a--)e[a]-=e[a-1];t+="{";for(let a=0;a<e.length;a++)t+=`${n.repeat(e[a])}|`;let s=Math.max(...o.params.map(a=>a.length));t+=`${n.repeat(s-p)}}`}else{let p=Math.max(...o.params.map(s=>s.length));t+=`{${n.repeat(p)}}`}return[t,"\\end{array}"]}function C(o){switch(o.type){case"Const":return o.tex;case"Root":{let e=o.body.map(C).join(" ");return o.body.find(t=>t.type==="Const"&&(t.value==="&"||t.tex==="\\\\"))&&(e=`\\begin{aligned}${e}\\end{aligned}`),e}case"Flat":return o.body.map(C).join(" ");case"Matrix":{let[e,t]=Y(o);return[o.lparen,e,o.params.map(n=>n.map(C).join(" & ")).join(" \\\\ "),t,o.rparen].join(" ")}case"ParamOne":return o.tex.replace("$1",C(o.params));case"ParamTwo":return o.tex.replace("$1",C(o.params[0])).replace("$2",C(o.params[1]))}}var _=/[0-9]/,J=/\S/,ee=o=>{let{value:e="",current:t,pos:n}=o;return{value:e,isKeyWord:!1,current:t,pos:n,tex:e,type:"Const"}},A=class{_root;_char_to_index=new Map;_n;constructor(e){if(e.length===0)throw new Error("Cannot create Trie since the length of nodes is 0");e.forEach(n=>{if(n.length!==1)throw new Error(`Value \`${n}\` is invalid, the length of char must be 1`)});let t=Array.from(new Set(e));this._n=t.length,this._root=new b(this._n),t.forEach((n,p)=>{this._char_to_index.set(n,p)})}c2i(e){return this._char_to_index.get(e)}insert(e){if(e.length===0)return;let t=this._root;[...e].forEach((n,p)=>{let s=this.c2i(n);if(typeof s>"u")throw new Error(`key \`${n}\` not in key set`);t._nextNode[s]===null&&(t._nextNode[s]=new b(this._n)),t=t._nextNode[s],p===e.length-1&&(t._end=!0)})}search(e){if(!this._root._nextNode.find(p=>p!==null)||e.length===0)return!1;let t=this._root,n=0;for(;n<e.length;n++){let p=e[n],s=this.c2i(p);if(typeof s>"u")throw new Error(`key \`${p}\` not in key set`);if(t._nextNode[s]===null)return!1;t=t._nextNode[s]}return n===e.length}tryParsing(e,t=0,n={line:1,ch:0}){let p="",s=this._root,a=!1,r=t;for(;r<e.length;r++){let y=e[r],T=this.c2i(y);if(typeof T>"u"||s._nextNode[T]===null)break;p+=y,s=s._nextNode[T],a=s._end}let i=a?f.get(p):{tex:p,type:"StringLiteral"};return{value:p,isKeyWord:a,current:r,...i,pos:n}}tryParsingNumber(e,t,n){let p=e[t],s="";for(;_.test(p)&&t<e.length;)s+=p,p=e[++t];for(p==="."&&(s+=p,p=e[++t]);_.test(p)&&t<e.length;)s+=p,p=e[++t];return{value:s,isKeyWord:!1,current:t,pos:n,tex:s,type:"NumberLiteral"}}tryParsingString(e,t,n){let p=e[t],s="";for(;J.test(p)&&t<e.length;){let a=this.c2i(p);if(typeof a<"u"&&this._root._nextNode[a]!==null)break;s+=p,p=e[++t]}return{value:s,isKeyWord:!1,current:t,pos:n,tex:s,type:"StringLiteral"}}tryParsingNewLines(e,t,n){let p=e[t],s="";for(;/\n/.test(p)&&t<e.length;)s+=p,p=e[++t],n.line++,n.ch=0;return s.length>=2?{value:s,isKeyWord:!0,current:t,pos:n,tex:"\\\\",type:"Align"}:{value:"",isKeyWord:!1,current:t,pos:n,tex:"",type:"None"}}getPlainTextInDoubleQuote(e,t,n){let p="",s=e[t];if(s==='"'){for(s=e[++t];s!=='"'&&t<e.length;)p+=s,s=e[++t];if(s==='"')return t++,{current:t,value:p,pos:n}}return{value:p,current:t,pos:n}}tryParsingText(e,t,n){let{value:p,current:s}=this.getPlainTextInDoubleQuote(e,t,n);return{value:p,isKeyWord:!1,current:s,pos:n,tex:p,type:"Text"}}skipSpaces(e,t){for(;t<e.length;){let n=e[t];if(!/\s/.test(n))break;t++}return t}eatNext(e,t,n){t=this.skipSpaces(e,t);let p=ee({current:t,pos:n});if(t>=e.length)return p;let s=e[t],a="";switch(s){case'"':{for(s=e[++t];t<e.length&&s!=='"';)a+=s,s=e[++t];t++;break}case"(":{for(s=e[++t];t<e.length&&s!==")";)a+=s,s=e[++t];t++;break}default:{for(;t<e.length&&/\S/.test(s);)s=e[t++],a+=s;break}}return p.tex=p.value=a,p.current=t,p}tryParsingAll(e){let t=0,n=[],p=0,s=[...e],a=1,r=0;for(;t<s.length;){{let y=this.tryParsingNewLines(s,t,{line:a,ch:r});if(a=y.pos.line,r=y.pos.ch,t=y.current,y.value!==""){n.push(y);continue}}if(/\s/.test(s[t])){t++,r++;continue}let i=this.tryParsing(s,t,{line:a,ch:r});if(r+=i.current-t,t=i.current,i.value!==""){if(n.push(i),i.eatNext){let y=this.eatNext(s,t,{line:a,ch:r});r+=y.current-t,t=y.current,n.push(y)}continue}{let y=this.tryParsingNumber(s,t,{line:a,ch:r});if(r+=y.current-t,t=y.current,y.value!==""){n.push(y);continue}}{let y=this.tryParsingText(s,t,{line:a,ch:r});if(r+=y.current-t,t=y.current,y.value!==""){n.push(y);continue}}{let y=this.tryParsingString(s,t,{line:a,ch:r});if(r+=y.current-t,t=y.current,y.value!==""){n.push(y);continue}}if(p++,p>s.length*2)throw new Error("Oops! There may be an infinity loop!")}return n}},b=class{_nextNode=[];_end=!1;constructor(e){this._nextNode=Array.from({length:e},()=>null)}};function S(o={}){let e=new Set([]);o.symbols&&(Array.isArray(o.symbols)?o.symbols.forEach(([p,s])=>{if(p.length===0)throw new Error(`Cannot insert empty token! Token value: ${s}`);f.set(p,s)}):Object.entries(o.symbols).forEach(([p,s])=>{if(p.length===0)throw new Error(`Cannot insert empty token! Token value: ${s}`);f.set(p,s)}));for(let p of f.keys())[...p].forEach(s=>e.add(s));let t=Array.from(e);t.push(" ");let n=new A(t);for(let p of f.keys())n.insert(p);return n}function te(o){let e={display:!0,symbols:{dx:{type:"Const",tex:"{\\text{d}x}"},dy:{type:"Const",tex:"{\\text{d}y}"},dz:{type:"Const",tex:"{\\text{d}z}"},dt:{type:"Const",tex:"{\\text{d}t}"},"#":{type:"Const",tex:"\\displaystyle"},atop:{type:"OperatorAOB",tex:"{ $1 \\atop $2 }"}},replaceBeforeTokenizing:[[/&#(x?[0-9a-fA-F]+);/g,(t,n)=>String.fromCodePoint(n[0]==="x"?`0${n}`:n)]]};return typeof o?.display<"u"&&(e.display=o.display),o?.symbols&&(Array.isArray(o.symbols)?o.symbols.forEach(([t,n])=>{e.symbols[t]=n}):e.symbols={...e.symbols,...o.symbols}),o?.replaceBeforeTokenizing?.length&&e.replaceBeforeTokenizing.push(...o.replaceBeforeTokenizing),e}var F=class{trie;display;replaceLaws;constructor(e){let{display:t,symbols:n,replaceBeforeTokenizing:p}=te(e);this.trie=S({symbols:n}),this.display=t,this.replaceLaws=p}toTex(e,t){try{e=this.replaceLaws.reduce((p,s)=>p.replaceAll(s[0],s[1]),e);let n=C(R(this.trie.tryParsingAll(e)));return typeof t?.display>"u"?this.display&&(n=`\\displaystyle{ ${n} }`):t.display&&(n=`\\displaystyle{ ${n} }`),n}catch(n){return`\\text{${String(n)}}`}}};

const customSymbols = `
the, \\text{the}
Id, \\text{Id}
Group, \\text{Group}
mor, \\text{mor}
Functor, \\text{Functor}
Category, \\text{Category}
suu, \\sqcup
suuu, \\bigsqcup
Gal, \\text{Gal}
Split, \\text{Split}
nolimits, \\nolimits
middle, \\middle
LIM, \\operatorname*{LIM}
[@, \\operatorname*{[}
{@, \\operatorname*{\\{}
(@, \\operatorname*{(}
big, \\Big
d/dt, \\frac{\\text{d}}{\\text{d}t}
d/dx, \\frac{\\text{d}}{\\text{d}x}
d/dy, \\frac{\\text{d}}{\\text{d}y}
du, \\text{d}u
dv, \\text{d}v
d alpha, \\text{d} \\alpha
<=, \\le
>=, \\ge
dom, \\text{dom}
cod, \\text{cod}
rank, \\text{rank}
ran, \\text{ran}
span, \\text{span}
nullity, \\text{nullity}
arg, \\text{arg}
s.t., \\text{ s.t. }
where, \\text{ where }
diag, \\text{diag}
cam, \\text{cam}
deg, \\text{deg}
depth, \\text{depth}
lub, \\text{lub}
inv, \\text{inv}
im, \\text{im}
ker, \\text{ker}
ob, \\text{ob}
hom, \\text{hom}
Set, \\text{Set}
Grp, \\text{Grp}
open, \\text{open}
closed, \\text{closed}
VectorSpace, \\text{VectorSpace}
FiniteVectorSpace, \\text{FiniteVectorSpace}
Basis, \\text{Basis}
OrderedBasis, \\text{OrderedBasis}
!:, \\mathrel{:\\!\\!\\mathrel{/}}
LinearCombination, \\text{LinearCombination}
Field, \\text{Field}
InnerProductSpace, \\text{InnerProductSpace}
FiniteInnerProductSpace, \\text{FiniteInnerProductSpace}
linear, \\text{linear}
bilinear, \\text{bilinear}
Basis, \\text{Basis}
sup, \\sup
Diagonal, \\text{Diagonal}
Eigenvalue, \\text{Eigenvalue}
Eigenvector, \\text{Eigenvector}
`;

function parseCustomSymbols(custom) {
  const out = {};
  custom.split('\n').forEach((line) => {
    const trimmed = line.trim();
    if (!trimmed) return;
    const idx = trimmed.indexOf(',');
    if (idx === -1) return;
    const key = trimmed.slice(0, idx).trim();
    const val = trimmed.slice(idx + 1).trim();
    if (!key) return;
    out[key] = { type: 'Const', tex: val };
  });
  return out;
}

const symbols = parseCustomSymbols(customSymbols);

const cfg = {
  symbols,
};

const am = new F(cfg);

function setupNavigationRefresh() {
  // Use Navigation API when available
  try {
    if (typeof navigation !== 'undefined' && typeof navigation.addEventListener === 'function' && 'navigate' in navigation) {
      navigation.addEventListener('navigate', () => setTimeout(() => translate(true), 500));
      return;
    }
  } catch (e) {}

  // Avoid double-binding
  if (window.__am_navigation_listeners_set) return;
  window.__am_navigation_listeners_set = true;

  const onNav = () => setTimeout(() => translate(true), 500);

  window.addEventListener('popstate', onNav);
  window.addEventListener('hashchange', onNav);
  window.addEventListener('pageshow', (e) => { if (e && e.persisted) onNav(); });

  // Monkeypatch pushState/replaceState so SPA navigations call our handler
  ['pushState', 'replaceState'].forEach((fn) => {
    const orig = history[fn];
    history[fn] = function (...args) {
      const ret = orig.apply(this, args);
      try { onNav(); } catch (e) {}
      return ret;
    };
  });

  window.addEventListener('pushstate', onNav);
}

setupNavigationRefresh();

const script = document.createElement('script');
script.onload = function () {
  translate();
};

script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js?ts=' + new Date().getTime();
document.head.appendChild(script);

const link = document.createElement("link");
link.rel = "stylesheet";
link.href = "https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css?ts=" + new Date().getTime();
document.head.appendChild(link);

function translate(refresh = false) {
  let pres =  document.getElementsByTagName('pre');
  pres =  Array.from(document.getElementsByTagName('pre'));

  for (let i = 0; i < pres.length; i++) {
    const pre = pres[i];
    if (pre.children[0].classList.contains('language-am')) {
      const para = pre.children[0].innerHTML
      .split('\n')
      .filter(e => e)
      .reduce((acc, code) => acc + 
      processCode(code)
        + '<br/>', '');
      pre.outerHTML = '<p style="text-align:center">' + para + '</p>';        
    }
  }
}

function processCode(code) {
  code = code.replaceAll('&lt;', '<').replaceAll('&gt;', '>');
  result = am.toTex(code);
  result = katex.renderToString(result, { throwOnError: false });
  return result;
}